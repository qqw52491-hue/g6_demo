# G6 å›¾è°±æ ·å¼ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ (Style System Architecture)

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†æœ¬é¡¹ç›®ä¸­ä½¿ç”¨çš„åŸºäºè¯­ä¹‰åˆ†å±‚å’ŒçŠ¶æ€å åŠ çš„æ ·å¼ç³»ç»Ÿã€‚

## 1. æ ¸å¿ƒè®¾è®¡å“²å­¦ (Core Philosophy)

### 1.1 çŠ¶æ€é©±åŠ¨ (State-Driven)
æˆ‘ä»¬ä¸ç›´æ¥ä¿®æ”¹èŠ‚ç‚¹çš„æ ·å¼ï¼ˆå¦‚é¢œè‰²ã€å¤§å°ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ç®¡ç†èŠ‚ç‚¹çš„ **â€œçŠ¶æ€â€ (State)** æ¥é—´æ¥å½±å“æ ·å¼ã€‚
*   âŒ é”™è¯¯ï¼š`node.update({ style: { fill: 'red' } })`
*   âœ… æ­£ç¡®ï¼š`stateManager.addReason(nodeId, 'critical', 'reason_id')`

### 1.2 ç†ç”±è¿½è¸ª (Reason Tracking)
ä¸ºäº†è§£å†³å¤šä¸šåŠ¡æ¨¡å—åŒæ—¶æ“ä½œåŒä¸€ä¸ªèŠ‚ç‚¹å¯¼è‡´çš„çŠ¶æ€å†²çªï¼Œæˆ‘ä»¬é‡‡ç”¨äº† **Set<ReasonID>** çš„æœºåˆ¶ã€‚
*   æ•°æ®ç»“æ„ï¼š`State -> Set<ReasonID>`
*   ä¼˜åŠ¿ï¼šè‡ªåŠ¨å»é‡ï¼Œæ— éœ€ç»´æŠ¤å¼•ç”¨è®¡æ•°ã€‚åªè¦è¿˜æœ‰ä¸€ä¸ªä¸šåŠ¡æ¨¡å—éœ€è¦è¯¥çŠ¶æ€ï¼ˆReason é›†åˆéç©ºï¼‰ï¼ŒçŠ¶æ€å°±ä¿æŒæ¿€æ´»ã€‚

---

## 2. æ··åˆæ¨¡å¼ä¸ä¼˜å…ˆçº§ (Blending & Priority)

å½“ä¸€ä¸ªèŠ‚ç‚¹åŒæ—¶æ¿€æ´»å¤šä¸ªçŠ¶æ€æ—¶ï¼ˆå¦‚æ—¢è¢« Hoverï¼Œåˆæ˜¯æœç´¢ç»“æœï¼Œå…¨å›¾è¿˜åœ¨å˜æš—ï¼‰ï¼Œæœ€ç»ˆæ ·å¼é€šè¿‡ `resolveStyle` è®¡ç®—å¾—å‡ºã€‚

### 2.1 ä¼˜å…ˆçº§ (Priority)
åœ¨ `src/graph/constants.js` ä¸­å®šä¹‰äº† `THEME` å¯¹è±¡ï¼Œå…¶é”®å€¼å¯¹çš„é¡ºåºå†³å®šäº†é»˜è®¤ä¼˜å…ˆçº§ã€‚
*   **Layer è¶Šé«˜ï¼Œè¯è¯­æƒè¶Šé‡**ã€‚
*   ä¾‹å¦‚ï¼š`highlight` (60) > `dimmed` (10)ã€‚

### 2.2 æ··åˆç­–ç•¥ (Blending Strategy)
æˆ‘ä»¬å®šä¹‰äº†ä¸åŒçš„å±æ€§å¦‚ä½•å åŠ ã€‚ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹ç‰¹æ®Šè§„åˆ™ï¼š

#### âš ï¸ å…³é”®è§„åˆ™ï¼šé€æ˜åº¦ (Opacity) çš„æ™ºèƒ½æ··åˆ
ä¸ºäº†åœ¨æ”¯æŒâ€œå›¾å±‚å åŠ â€çš„åŒæ—¶ï¼Œä¹Ÿèƒ½æ”¯æŒâ€œèšå…‰ç¯ (Spotlight)â€æ•ˆæœï¼Œæˆ‘ä»¬å¯¹ `opacity` é‡‡ç”¨äº†ç‰¹æ®Šç®—æ³•ï¼š

```javascript
opacity: (prev, curr) => curr === 1 ? 1 : prev * curr
```

*   **è§„åˆ™ A (å åŠ æ¨¡å¼)**ï¼šå¦‚æœæ–°çŠ¶æ€çš„ `opacity` æ˜¯å°æ•°ï¼ˆå¦‚ 0.5ï¼‰ï¼Œåˆ™è¿›è¡Œ **ä¹˜æ³•å åŠ **ã€‚
    *   åœºæ™¯ï¼š`Base(1.0) * Dimmed(0.2) = 0.2` (å˜æš—)
*   **è§„åˆ™ B (é‡ç½®æ¨¡å¼)**ï¼šå¦‚æœæ–°çŠ¶æ€çš„ `opacity` æ˜¾å¼è®¾ä¸º **1.0**ï¼Œåˆ™ **å¼ºåˆ¶é‡ç½®** ä¸ºä¸é€æ˜ã€‚
    *   åœºæ™¯ï¼š`Dimmed(0.2) + Highlight(1.0) = 1.0` (èšå…‰ç¯æ•ˆæœï¼šæ— è§†èƒŒæ™¯é»‘æš—ï¼Œå¼ºè¡Œäº®èµ·)

**ğŸ‘‰ æœ€ä½³å®è·µï¼š**
*   å¦‚æœä½ åªæ˜¯æƒ³åŠ ä¸ªè£…é¥°ï¼ˆå¦‚ Grid èƒŒæ™¯ï¼Œæˆ–æ˜¯ weak linkï¼‰ï¼Œè¯·ç”¨ `0.x`ã€‚
*   å¦‚æœä½ æƒ³è®©æŸä¸ªå…ƒç´ åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½æ¸…æ™°å¯è§ï¼ˆå¦‚ Selected, Highlightï¼‰ï¼Œè¯·åŠ¡å¿…æ˜¾å¼è®¾ç½® `opacity: 1`ã€‚
*   **ä¸è¦** éšä¾¿ç»™æ™®é€šçŠ¶æ€è®¾ç½® `opacity: 1`ï¼Œå¦åˆ™å®ƒä¼šæ¸…é™¤åº•ä¸‹æ‰€æœ‰çš„å˜æš—æ•ˆæœã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ™®é€šçŠ¶æ€ **ä¸è¦å†™** opacity å±æ€§ã€‚

#### å…¶ä»–å±æ€§æ··åˆ
*   **å°ºå¯¸ (r, width, lineWidth)**: å– `Math.max`ã€‚ä¿è¯èŠ‚ç‚¹è‡³å°‘å±•ç¤ºä¸ºæœ€å¤§çš„é‚£ä¸ªå°ºå¯¸ã€‚
*   **é˜´å½± (shadow)**: `Sum` (ç´¯åŠ )ã€‚å¤šé‡çŠ¶æ€æ—¶å…‰æ™•æ›´å¼ºã€‚

---

## 3. å®æˆ˜èŒƒä¾‹ï¼šèšå…‰ç¯æ¨¡å¼ (Spotlight Mode)

å¦‚ä½•å®ç°â€œå…¨å±å˜æš—ï¼Œå”¯ç‹¬é€‰ä¸­èŠ‚ç‚¹é«˜äº®â€ï¼Ÿ

```javascript
// 1. å…¨å±€æ·»åŠ  Dimmed åŸå›  (æ‰€æœ‰èŠ‚ç‚¹å˜æš— opacity: 0.2)
stateManager.addGlobalReason('dimmed', 'search_session');

// 2. ç›®æ ‡èŠ‚ç‚¹æ·»åŠ  Highlight åŸå›  (opacity: 1.0)
// ç”±äº Highlight ä¼˜å…ˆçº§(60) > Dimmed(10)ï¼Œä¸”æ»¡è¶³ opacity === 1 çš„é‡ç½®è§„åˆ™
// ç›®æ ‡èŠ‚ç‚¹å°† "å‡»ç©¿" é»‘æš—ï¼Œå®Œå…¨äº®èµ·ã€‚
targets.forEach(id => {
    stateManager.addReason(id, 'highlight', 'search_session');
});

// 3. åˆ·æ–°è§†å›¾
graph.paint();
```

## 4. ç›®å½•ç»“æ„
*   `constants.js`: å®šä¹‰æ‰€æœ‰çŠ¶æ€çš„å±‚çº§ã€é»˜è®¤æ ·å¼å’Œæ··åˆç®—æ³•ã€‚
*   `StateManager.js`: ç®¡ç†çŠ¶æ€çš„å¢åˆ æŸ¥æ”¹ (CRUD)ã€‚
*   `StyleResolver.js`: æ‰§è¡Œå…·ä½“çš„è®¡ç®—é€»è¾‘ (Sort & Blend)ã€‚
*   `registerNode.js`: å°†è®¡ç®—å¥½çš„æ ·å¼åº”ç”¨åˆ° G6 å›¾å½¢ä¸Šã€‚
